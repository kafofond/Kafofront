<div class="content-toolbar">
    <div class="filter-dropdown-container">
        <button class="filter-btn" (click)="toggleFilterDropdown($event)">
            <img src="assets/417_213.svg" alt="Filtrer">
            <span>Filtrer</span>
            <span class="active-filter-label" *ngIf="activeFilter !== 'Aucun'">({{ activeFilter }})</span>
        </button>

        <div class="filter-dropdown" *ngIf="showFilterDropdown" (click)="$event.stopPropagation()">
            <div class="dropdown-header">Filtrer par statut</div>
            <button class="dropdown-item" (click)="applyFilter('Validé')">
                Validé
                <span class="check-icon" *ngIf="activeFilter === 'Validé'">✓</span>
            </button>
            <button class="dropdown-item" (click)="applyFilter('En cours')">
                En cours
                <span class="check-icon" *ngIf="activeFilter === 'En cours'">✓</span>
            </button>
            <button class="dropdown-item" (click)="applyFilter('Refusé')">
                Refusé
                <span class="check-icon" *ngIf="activeFilter === 'Refusé'">✓</span>
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item reset" (click)="applyFilter('Aucun')">
                Réinitialiser le filtre
            </button>
        </div>
    </div>

    <button class="filter-btn" (click)="openCreateBudgetModal()">
        <span>Créer Budget</span>
    </button>
</div>

<div class="budget-table-container">
    <div class="budget-table">
        <div class="table-header">
            <div>Intitulé</div>
            <div>État</div>
            <div>Statut</div>
            <div>Montant Alloué</div>
            <div>Actions</div>
        </div>
        <div class="table-body">
            <div class="table-row" *ngFor="let budget of budgets">
                <div>{{ budget.intituleBudget }}</div>
                <div>
                    <span [class]="getEtatBadgeClass(budget.etat)">{{ budget.etat }}</span>
                </div>
                <div>
                    <span [class]="getStatusBadgeClass(budget.statut)">{{ budget.statut }}</span>
                </div>
                <div>{{ budget.montantBudget | number }} FCFA</div>
                <div class="actions-cell"> 
                    <button class="action-link" (click)="loadLignesBudget(budget)">Voir lignes</button>
                    <button class="action-icon-btn" (click)="openDetailBudgetModal(budget)">
                        <img src="assets/417_144.svg" alt="View Details">
                    </button>
                    <button class="action-icon-btn edit-btn" (click)="openEditBudgetModal(budget)">
                        <img src="assets/32_236.svg" alt="Modifier">
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination Controls -->
<div class="pagination-controls" *ngIf="totalPages > 1">
    <button class="pagination-btn" (click)="prevPage()" [disabled]="currentPage === 1">
        Précédent
    </button>
    
    <span class="pagination-info">
        Page {{ currentPage }} sur {{ totalPages }}
    </span>
    
    <button class="pagination-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
        Suivant
    </button>
</div>

<!-- Modal Création Budget -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateBudgetModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Créer un nouveau budget</h2>
            <button class="close-btn" (click)="closeCreateBudgetModal()">
                <img src="assets/mdi_cancel-bold.svg" alt="Fermer" class="close-icon">
            </button>
        </div>

        <form class="budget-form" (ngSubmit)="onCreateBudgetSubmit()">
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="intitule">Intitulé du budget</label>
                        <input type="text" id="intitule" [(ngModel)]="createFormData.intituleBudget" name="intituleBudget" placeholder="Ex: Budget Marketing 2026" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="montant">Montant Alloué (FCFA)</label>
                        <input type="number" id="montant" [(ngModel)]="createFormData.montantBudget" name="montantBudget" placeholder="Ex: 15000000" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="description">Description</label>
                        <textarea id="description" [(ngModel)]="createFormData.description" name="description" rows="3" placeholder="Description courte des objectifs et de l'utilisation du budget..."></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section date-section">
                <div class="form-row">
                    <div class="form-group third-width">
                        <label for="dateDebut">Date de début</label>
                        <input type="date" id="dateDebut" [(ngModel)]="createFormData.dateDebut" name="dateDebut">
                    </div>
                    <div class="form-group third-width">
                        <label for="dateFin">Date de fin</label>
                        <input type="date" id="dateFin" [(ngModel)]="createFormData.dateFin" name="dateFin">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary cancel-btn" (click)="closeCreateBudgetModal()">Annuler</button>
                <button type="submit" class="btn btn-primary save-btn">Enregistrer le budget</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Détails Budget -->
<div class="modal-overlay" *ngIf="selectedBudget && !showEditModal && !showRejetModal" (click)="closeDetailBudgetModal()">
    <div class="modal-content detail-modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header detail-header">
            <h2 class="modal-title">Budget : {{ selectedBudget.codeBudget }}</h2>
            <button class="close-btn" (click)="closeDetailBudgetModal()">
                <img src="assets/mdi_cancel-bold.svg" alt="Fermer" class="close-icon">
            </button>
        </div>

        <div class="detail-body">
            <div class="detail-section full-width-fields">
                <div class="detail-group">
                    <label>Intitulé</label>
                    <p class="detail-value">{{ selectedBudget.intituleBudget }}</p>
                </div>
                <div class="detail-group">
                    <label>Description</label>
                    <p class="detail-value description">{{ selectedBudget.description }}</p>
                </div>
            </div>

            <div class="detail-section grid-fields">
                <div class="detail-group">
                    <label>Montant Alloué</label>
                    <p class="detail-value">{{ selectedBudget.montantBudget | number:'1.0-0' }} FCFA</p>
                </div>
                <div class="detail-group">
                    <label>Statut</label>
                    <span [class]="getStatusBadgeClass(selectedBudget.statut)">{{ selectedBudget.statut }}</span>
                </div>
                <div class="detail-group">
                    <label>Date de création</label>
                    <p class="detail-value">{{ selectedBudget.dateDeCreation | date:'dd/MM/yyyy' }}</p>
                </div>
                <div class="detail-group">
                    <label>État</label>
                    <span [class]="getEtatBadgeClass(selectedBudget.etat)">{{ selectedBudget.etat }}</span>
                </div>
                <div class="detail-group">
                    <label>Période</label>
                    <p class="detail-value">{{ selectedBudget.dateDeDebut | date:'dd/MM/yyyy' }} - {{ selectedBudget.dateDeFin | date:'dd/MM/yyyy' }}</p>
                </div>
            </div>

            <div class="detail-section full-width-fields">
                <div class="detail-group">
                    <label>Commentaire</label>
                    <p class="detail-value comment">{{ selectedBudget.commentaire || 'Aucun commentaire.' }}</p>
                </div>
            </div>
        </div>

        <div class="modal-footer detail-footer">
            <p class="creation-info">Créé le : {{ selectedBudget.dateDeCreation | date:'dd/MM/yyyy' }}</p>
            <button class="btn btn-primary" (click)="closeDetailBudgetModal()">Fermer</button>
        </div>
    </div>
</div>

<!-- Modal Édition Budget avec contrôles automatiques -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditBudgetModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Modifier le budget : {{ selectedBudget?.codeBudget || 'N/A' }}</h2>
            <button class="close-btn" (click)="closeEditBudgetModal()">
                <img src="assets/mdi_cancel-bold.svg" alt="Fermer" class="close-icon">
            </button>
        </div>

        <form class="budget-form" (ngSubmit)="saveEditedBudget()">
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="intituleEdit">Intitulé du budget</label>
                        <input type="text" id="intituleEdit" [(ngModel)]="editFormData.intituleBudget" name="intituleBudget" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="montantEdit">Montant Alloué (FCFA)</label>
                        <input type="number" id="montantEdit" [(ngModel)]="editFormData.montantBudget" name="montantBudget" required>
                    </div>
                    
                    <!-- Select pour le statut avec actions automatiques -->
                    <div class="form-group half-width">
                        <label for="statutEdit">Statut</label>
                        <select id="statutEdit" 
                                [(ngModel)]="editFormData.statut" 
                                name="statut"
                                (change)="onStatutChange($event)"
                                class="form-control">
                            <option value="En cours">En cours</option>
                            <option value="Validé">Validé</option>
                            <option value="Refusé">Refusé</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="descriptionEdit">Description</label>
                        <textarea id="descriptionEdit" [(ngModel)]="editFormData.description" name="description" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section date-section">
                <div class="form-row">
                    <div class="form-group third-width">
                        <label for="dateDebutEdit">Date de début</label>
                        <input type="date" id="dateDebutEdit" [(ngModel)]="editFormData.dateDebut" name="dateDebut">
                    </div>
                    <div class="form-group third-width">
                        <label for="dateFinEdit">Date de fin</label>
                        <input type="date" id="dateFinEdit" [(ngModel)]="editFormData.dateFin" name="dateFin">
                    </div>
                    
                    <!-- Toggle pour état actif/inactif avec actions automatiques -->
                    <div class="form-group third-width toggle-group">
                        <label>État du budget</label>
                        <div class="toggle-control">
                            <span>Inactif</span>
                            <label class="switch">
                                <input 
                                    type="checkbox" 
                                    [(ngModel)]="editFormData.etat" 
                                    name="etat"
                                    (change)="onEtatToggle($event)">
                                <span class="slider round"></span>
                            </label>
                            <span>Actif</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary cancel-btn" (click)="closeEditBudgetModal()">Annuler</button>
                <button type="submit" class="btn btn-primary save-btn">Enregistrer les modifications</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Rejet Budget -->
<div class="modal-overlay" *ngIf="showRejetModal" (click)="closeRejetModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Rejeter le budget</h2>
            <button class="close-btn" (click)="closeRejetModal()">
                <img src="assets/mdi_cancel-bold.svg" alt="Fermer" class="close-icon">
            </button>
        </div>

        <div class="form-section">
            <div class="form-group full-width">
                <label for="commentaireRejet">Commentaire de rejet *</label>
                <textarea id="commentaireRejet" 
                          [(ngModel)]="rejetCommentaire" 
                          name="commentaireRejet" 
                          rows="4" 
                          placeholder="Veuillez saisir la raison du rejet..."
                          required></textarea>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary cancel-btn" (click)="closeRejetModal()">Annuler</button>
            <button type="button" class="btn btn-danger save-btn" 
                    (click)="rejeterBudget()"
                    [disabled]="!rejetCommentaire.trim()">
                Confirmer le rejet
            </button>
        </div>
    </div>
</div>