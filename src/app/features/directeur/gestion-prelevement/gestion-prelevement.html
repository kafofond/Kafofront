<section class="content-area">
  <!-- Barre de filtre -->
  <div class="filter-bar">
    <div class="filter-group">
      <label>Statut :</label>
      <div class="filter-select" (click)="toggleStatusDropdown()">
        <span>{{ selectedStatus }}</span>
      </div>
      <ul class="dropdown-list" *ngIf="statusDropdownOpen">
        <li *ngFor="let s of ['Tous', 'Validé', 'En attente', 'Rejeté']"
            (click)="setStatus(s)"
            [class.active]="selectedStatus === s">
          {{ s }}
        </li>
      </ul>
    </div>
    <button class="export-btn">
      <img src="assets/87_477.svg" alt="Export Icon">
      <span>Exporter</span>
    </button>
  </div>

  <!-- Indicateur de chargement -->
  <div *ngIf="isLoading" class="loading-indicator">
    <div class="spinner"></div>
    <p>Chargement des données...</p>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="errorMessage" class="error-banner">
    {{ errorMessage }}
    <button class="retry-btn" (click)="loadData()">Réessayer</button>
  </div>

  <div class="data-card" *ngIf="!isLoading">

    <!-- Tableau 1 : Decision De Prelevement -->
    <div class="table-section">
      <h2 class="table-title">Décisions de Prélèvement</h2>
      <div class="data-table">
        <div class="table-header">
          <div class="col col-1">Code</div>
          <div class="col col-3">Montant</div>
          <div class="col col-4">Compte Destinataire</div>
          <div class="col col-5">Statut</div>
          <div class="col col-6">Actions</div>
        </div>

        <div class="table-row" *ngFor="let dec of filteredDecisions">
          <div class="col col-1">{{ dec.code }}</div>
          <div class="col col-3">{{ formatCurrency(dec.montant) }}</div>
          <div class="col col-4">{{ dec.compteDestinataire }}</div>
          <div class="col col-5">
            <span class="status-badge" [ngClass]="getStatusBadgeClass(dec.statut)">
              {{ mapStatutToDisplay(dec.statut) }}
            </span>
          </div>
          <div class="col col-6">
            <!-- Bouton détails -->
            <button class="action-btn" (click)="openDetailDecisionModal(dec)">
              <img src="assets/87_501.svg" alt="details"/>
            </button>           
            <!-- Bouton Valider - TOUJOURS VISIBLE -->
            <button class="action-btn" (click)="validerDecision(dec)">
              <img src="assets/Frame icon approuver.svg" alt="valider"/>
            </button>           
            <!-- Bouton Refuser - TOUJOURS VISIBLE -->
            <button class="action-btn" (click)="refuserDecision(dec)">
              <img src="assets/Frame icon refuser.svg" alt="refuser"/>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tableau 2 : Ordre De Paiement -->
    <div class="table-section">
      <h2 class="table-title">Ordres de Paiement</h2>
      <div class="data-table">
        <div class="table-header">
          <div class="col col-1">Code</div>
          <div class="col col-3">Montant</div>
          <div class="col col-4">Compte Destinataire</div>
          <div class="col col-5">Statut</div>
          <div class="col col-6">Actions</div>
        </div>

        <div class="table-row" *ngFor="let od of filteredOrdres">
          <div class="col col-1">{{ od.code }}</div>
          <div class="col col-3">{{ formatCurrency(od.montant) }}</div>
          <div class="col col-4">{{ od.compteDestinataire }}</div>
          <div class="col col-5">
            <span class="status-badge" [ngClass]="getStatusBadgeClass(od.statut)">
              {{ mapStatutToDisplay(od.statut) }}
            </span>
          </div>
          <div class="col col-6">
            <!-- Bouton détails -->
            <button class="action-btn" (click)="openDetailOrdreModal(od)">
              <img src="assets/87_501.svg" alt="details" />
            </button>
            <!-- Bouton Valider - TOUJOURS VISIBLE -->
            <button class="action-btn" (click)="validerOrdre(od)">
              <img src="assets/Frame icon approuver.svg" alt="valider" />
            </button>
            <!-- Bouton Refuser - TOUJOURS VISIBLE -->
            <button class="action-btn" (click)="refuserOrdre(od)">
              <img src="assets/Frame icon refuser.svg" alt="refuser" />
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modales pour les détails (gardées telles quelles) -->
<div class="modal-overlay" *ngIf="showDecisionModal" (click)="closeDetailDecisionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Détails de la Décision: {{ selectedDecision?.code }}</h2>
      <button class="close-btn" (click)="closeDetailDecisionModal()">×</button>
    </div>
    <div class="modal-body" *ngIf="selectedDecision">
      <div class="detail-grid">
        <div class="detail-item">
          <label>Référence Attestation:</label>
          <span>{{ selectedDecision.referenceAttestation || 'N/A' }}</span>
        </div>
        <div class="detail-item">
          <label>Montant:</label>
          <span>{{ formatCurrency(selectedDecision.montant) }}</span>
        </div>
        <div class="detail-item">
          <label>Compte Origine:</label>
          <span>{{ selectedDecision.compteOrigine }}</span>
        </div>
        <div class="detail-item">
          <label>Compte Destinataire:</label>
          <span>{{ selectedDecision.compteDestinataire }}</span>
        </div>
        <div class="detail-item">
          <label>Motif:</label>
          <span>{{ selectedDecision.motifPrelevement }}</span>
        </div>
        <div class="detail-item">
          <label>Statut:</label>
          <span [ngClass]="getStatusBadgeClass(selectedDecision.statut)">
            {{ mapStatutToDisplay(selectedDecision.statut) }}
          </span>
        </div>
        <div class="detail-item">
          <label>Date de création:</label>
          <span>{{ selectedDecision.dateCreation | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showOrdreModal" (click)="closeDetailOrdreModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Détails de l'Ordre: {{ selectedOrdre?.code }}</h2>
      <button class="close-btn" (click)="closeDetailOrdreModal()">×</button>
    </div>
    <div class="modal-body" *ngIf="selectedOrdre">
      <div class="detail-grid">
        <div class="detail-item">
          <label>Référence Décision:</label>
          <span>{{ selectedOrdre.referenceDecisionPrelevement || 'N/A' }}</span>
        </div>
        <div class="detail-item">
          <label>Montant:</label>
          <span>{{ formatCurrency(selectedOrdre.montant) }}</span>
        </div>
        <div class="detail-item">
          <label>Description:</label>
          <span>{{ selectedOrdre.description }}</span>
        </div>
        <div class="detail-item">
          <label>Compte Origine:</label>
          <span>{{ selectedOrdre.compteOrigine }}</span>
        </div>
        <div class="detail-item">
          <label>Compte Destinataire:</label>
          <span>{{ selectedOrdre.compteDestinataire }}</span>
        </div>
        <div class="detail-item">
          <label>Statut:</label>
          <span [ngClass]="getStatusBadgeClass(selectedOrdre.statut)">
            {{ mapStatutToDisplay(selectedOrdre.statut) }}
          </span>
        </div>
        <div class="detail-item">
          <label>Date de création:</label>
          <span>{{ selectedOrdre.dateCreation | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="detail-item" *ngIf="selectedOrdre.dateExecution">
          <label>Date d'exécution:</label>
          <span>{{ selectedOrdre.dateExecution | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modale de confirmation pour l'approbation -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
  <div class="modal-content confirmation-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ getActionTitle() }}</h2>
      <button class="close-btn" (click)="closeConfirmModal()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirmation-text">{{ getActionDescription() }}</p>
      <div class="confirmation-actions">
        <button class="btn btn-secondary" (click)="closeConfirmModal()">Annuler</button>
        <button class="btn btn-primary" (click)="executeAction()">Confirmer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modale pour le rejet avec commentaire -->
<div class="modal-overlay" *ngIf="showRejectModal" (click)="closeConfirmModal()">
  <div class="modal-content rejection-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ getActionTitle() }}</h2>
      <button class="close-btn" (click)="closeConfirmModal()">×</button>
    </div>
    <div class="modal-body">
      <p class="rejection-text">{{ getActionDescription() }}</p>
      <div class="form-group">
        <label for="rejectComment">Commentaire (obligatoire):</label>
        <textarea 
          id="rejectComment" 
          [(ngModel)]="rejectComment" 
          placeholder="Veuillez saisir la raison du rejet..."
          rows="4"
          class="comment-textarea"
        ></textarea>
      </div>
      <div class="confirmation-actions">
        <button class="btn btn-secondary" (click)="closeConfirmModal()">Annuler</button>
        <button class="btn btn-danger" (click)="executeAction()" [disabled]="!rejectComment.trim()">
          Confirmer le rejet
        </button>
      </div>
    </div>
  </div>
</div>