<div class="content-header">
  <div class="header-left">
    <button class="action-btn back-button" routerLink="/directeur/listbudget-directeur">
      <img src="assets/tabler_arrow-left.svg" alt="Retour" />
      <span>Retour</span>
    </button>
  </div>

  <h3 class="content-title">Lignes de crédit budgétaire - Budget #{{ budgetId }}</h3>

  <div class="header-right">
    <button class="action-btn filter-button">
      <img src="assets/417_213.svg" alt="Filtrer" />
      <span>Filtrer</span>
    </button>
    <button class="action-btn credit-button" (click)="openCreateLigneModal()">
      <img src="assets/foundation_plus.svg" alt="Ajouter" />
      <span>Nouvelle ligne</span>
    </button>
  </div>
</div>

<div class="budget-table-container">
  <div class="budget-table">
    <div class="table-header">
      <div>Intitulé</div>
      <div>Montant Alloué</div>
      <div>Montant Engagé</div>
      <div>Montant Restant</div>
      <div>Taux d'utilisation</div>
      <div>Statut</div>
      <div>Actions</div>
    </div>

    <div class="table-body">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div>Chargement des lignes de crédit...</div>
      </div>

      <!-- Error State -->
      <div *ngIf="errorMessage && !isLoading" class="error-state">
        <div>{{ errorMessage }}</div>
      </div>

      <!-- Data -->
      <div class="table-row" *ngFor="let ligne of lignes">
        <div class="col-intitule">
          <span class="item-title">{{ ligne.intituleLigne }}</span>
          <div class="item-description">{{ ligne.description }}</div>
        </div>
        <div>{{ ligne.montantAlloue | number }} FCFA</div>
        <div>{{ ligne.montantEngage | number }} FCFA</div>
        <div>{{ ligne.montantRestant | number }} FCFA</div>
        <div class="col-taux">
          <div class="progress-bar">
            <div class="progress-bar-inner" [style.width.%]="ligne.tauxUtilisation"></div>
          </div>
          <span class="progress-percent">{{ ligne.tauxUtilisation }}%</span>
        </div>
        <div>
          <span [class]="getStatusBadgeClass(ligne.statut)">{{ ligne.statut }}</span>
        </div>
        <div class="actions-cell">
          <button class="action-icon-btn" title="Voir détails" (click)="openDetailLigneModal(ligne)">
            <img src="assets/417_144.svg" alt="Détails" />
          </button>
          <button class="action-icon-btn" title="Modifier" (click)="openEditLigneModal(ligne)">
            <img src="assets/32_236.svg" alt="Modifier" />
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="lignes.length === 0 && !isLoading && !errorMessage" class="empty-state">
        <div>Aucune ligne de crédit trouvée pour ce budget</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour la création de nouvelle ligne de crédit -->
<div class="modal-overlay" *ngIf="showCreateLigneModal" (click)="closeCreateLigneModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Créer une nouvelle ligne de crédit</h2>
      <button class="close-btn" (click)="closeCreateLigneModal()">
        <img src="assets/mdi_cancel-bold.svg" alt="Fermer" class="close-icon">
      </button>
    </div>

    <form class="budget-form" (ngSubmit)="submitNewLigneCredit()"> 
      <div class="form-section">
        <div class="form-row">
          <div class="form-group full-width">
            <label for="intituleLigne">Intitulé de la ligne de crédit *</label>
            <input type="text" id="intituleLigne" name="intituleLigne" 
                   placeholder="Ex: Budget Achat Licences" 
                   [(ngModel)]="newLigneCredit.intituleLigne" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group half-width">
            <label for="montantAlloueLigne">Montant Alloué (FCFA) *</label>
            <input type="number" id="montantAlloueLigne" name="montantAlloue" 
                   placeholder="Ex: 5000000" 
                   [(ngModel)]="newLigneCredit.montantAlloue" required>
          </div>
          <div class="form-group half-width">
            <label for="budgetIdLigne">Budget ID</label>
            <input type="text" id="budgetIdLigne" [value]="budgetId" readonly>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="descriptionLigne">Description</label>
            <textarea id="descriptionLigne" name="description" rows="3" 
                      placeholder="Description courte de l'objectif de cette ligne de crédit..."
                      [(ngModel)]="newLigneCredit.description"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="commentaireLigne">Commentaire</label>
            <textarea id="commentaireLigne" name="commentaire" rows="2" 
                      placeholder="Ajoutez un commentaire ou une justification si nécessaire..."
                      [(ngModel)]="newLigneCredit.commentaire"></textarea>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary cancel-btn" 
                (click)="closeCreateLigneModal()">Annuler</button>
        <button type="submit" class="btn btn-primary save-btn"
                [disabled]="!newLigneCredit.intituleLigne || !newLigneCredit.montantAlloue">
          Soumettre la ligne de crédit
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal pour les détails d'une ligne de crédit -->
<div class="modal-overlay" *ngIf="showDetailLigneModal" (click)="closeDetailLigneModal()">
  <div class="modal-content detail-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header detail-header">
      <h2 class="modal-title">Détails de la ligne : {{ selectedLigne?.code }}</h2>
      <button class="close-btn" (click)="closeDetailLigneModal()">
        <img src="assets/mdi_cancel-bold.svg" alt="Fermer" class="close-icon">
      </button>
    </div>

    <div class="detail-body" *ngIf="selectedLigne">
      <div class="detail-section full-width-fields">
        <div class="detail-group">
          <label>Intitulé</label>
          <p class="detail-value">{{ selectedLigne.intituleLigne }}</p>
        </div>
        <div class="detail-group">
          <label>Description</label>
          <p class="detail-value description">{{ selectedLigne.description }}</p>
        </div>
      </div>

      <div class="detail-section grid-fields">
        <div class="detail-group">
          <label>Montant Alloué</label>
          <p class="detail-value">{{ selectedLigne.montantAlloue | number:'1.0-0' }} FCFA</p>
        </div>
        <div class="detail-group">
          <label>Montant Engagé</label>
          <p class="detail-value">{{ selectedLigne.montantEngage | number:'1.0-0' }} FCFA</p>
        </div>
        <div class="detail-group">
          <label>Montant Restant</label>
          <p class="detail-value">{{ selectedLigne.montantRestant | number:'1.0-0' }} FCFA</p>
        </div>
        <div class="detail-group">
          <label>Taux d'utilisation</label>
          <p class="detail-value">{{ selectedLigne.tauxUtilisation }}%</p>
        </div>
        <div class="detail-group">
          <label>Statut</label>
          <span [class]="getStatusBadgeClass(selectedLigne.statut)">{{ selectedLigne.statut }}</span>
        </div>
        <div class="detail-group">
          <label>État</label>
          <span [class]="getEtatBadgeClass(selectedLigne.etat)">{{ selectedLigne.etat ? 'Actif' : 'Inactif' }}</span>
        </div>
      </div>

      <div class="detail-section full-width-fields">
        <div class="detail-group">
          <label>Date de création</label>
          <p class="detail-value">{{ selectedLigne.dateDeCreation | date:'dd/MM/yyyy' }}</p>
        </div>
        <div class="detail-group">
          <label>Commentaire</label>
          <p class="detail-value comment">{{ selectedLigne.commentaire || 'Aucun commentaire.' }}</p>
        </div>
      </div>
    </div>

    <div class="modal-footer detail-footer">
      <p class="creation-info">Budget ID : {{ budgetId }}</p>
      <button class="btn btn-primary" (click)="closeDetailLigneModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- Modal pour la modification d'une ligne de crédit -->
<div class="modal-overlay" *ngIf="showEditLigneModal" (click)="closeEditLigneModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Modifier la ligne : {{ selectedLigne?.code }}</h2>
      <button class="close-btn" (click)="closeEditLigneModal()">
        <img src="assets/mdi_cancel-bold.svg" alt="Fermer" class="close-icon">
      </button>
    </div>

    <form class="budget-form" (ngSubmit)="submitEditLigne()" *ngIf="selectedLigne">
      <div class="form-section">
        <div class="form-row">
          <div class="form-group full-width">
            <label for="intituleEdit">Intitulé de la ligne *</label>
            <input type="text" id="intituleEdit" 
                   [(ngModel)]="editLigneData.intituleLigne" name="intituleLigne" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group half-width">
            <label for="montantEdit">Montant Alloué (FCFA) *</label>
            <input type="number" id="montantEdit" 
                   [(ngModel)]="editLigneData.montantAlloue" name="montantAlloue" required>
          </div>
          <div class="form-group half-width">
            <label for="statutEdit">Statut</label>
            <select id="statutEdit" [(ngModel)]="editLigneData.statut" name="statut" class="form-control">
              <option value="En cours">En cours</option>
              <option value="Validé">Validé</option>
              <option value="Refusé">Refusé</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="descriptionEdit">Description</label>
            <textarea id="descriptionEdit" name="description" rows="3"
                      [(ngModel)]="editLigneData.description"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="commentaireEdit">Commentaire</label>
            <textarea id="commentaireEdit" name="commentaire" rows="2"
                      [(ngModel)]="editLigneData.commentaire"></textarea>
          </div>
        </div>
      </div>

      <div class="form-section toggle-section">
        <div class="form-group full-width toggle-group">
          <label>État de la ligne (Actif/Inactif)</label>
          <div class="toggle-control">
            <span>Inactif</span>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="editLigneData.etat" name="etat">
              <span class="slider round"></span>
            </label>
            <span>Actif</span>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary cancel-btn" 
                (click)="closeEditLigneModal()">Annuler</button>
        <button type="submit" class="btn btn-primary save-btn"
                [disabled]="!editLigneData.intituleLigne || !editLigneData.montantAlloue">
          Enregistrer les modifications
        </button>
      </div>
    </form>
  </div>
</div>